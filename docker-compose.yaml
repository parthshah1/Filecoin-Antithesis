name: filecoin
x-templates:
  filecoin_service: &filecoin_service
    env_file: .env
    environment:
      - NUM_LOTUS_CLIENTS=2
      - NUM_FOREST_CLIENTS=1
    volumes:
      - ./data/lotus0:${LOTUS_0_DATA_DIR}
      - ./data/lotus1:${LOTUS_1_DATA_DIR}
      - ./data/forest0:${FOREST_0_DATA_DIR}
      - ./shared/configs:${SHARED_CONFIGS}
      - ./data/curio:/var/lib/curio:rw
    pull_policy: never
  needs_drand0_started: &needs_drand0_started
    depends_on:
      drand0:
        condition: service_started
  needs_all_drand_healthy: &needs_all_drand_healthy
    depends_on:
      drand0:
        condition: service_healthy
      drand1:
        condition: service_healthy
      drand2:
        condition: service_healthy
  needs_lotus0_healthy: &needs_lotus0_healthy
    depends_on:
      lotus0:
        condition: service_healthy
  needs_lotus1_healthy: &needs_lotus1_healthy
    depends_on:
      lotus1:
        condition: service_healthy
  needs_filwizard_healthy: &needs_filwizard_healthy
    depends_on:
      filwizard:
        condition: service_healthy
  healthcheck_settings: &healthcheck_settings
    interval: 5s
    timeout: 2s
    retries: 10

services:
  drand0:
    <<: [ *filecoin_service ]
    container_name: drand0
    image: drand:latest
    entrypoint: ./start-drand0.sh
    healthcheck:
      <<: *healthcheck_settings
      test: drand util ping http://drand0:8080

  drand1:
    <<: [ *filecoin_service, *needs_drand0_started ]
    container_name: drand1
    image: drand:latest
    entrypoint: ./start-drand1.sh
    healthcheck:
      <<: *healthcheck_settings
      test: drand util ping http://drand1:8080

  drand2:
    <<: [ *filecoin_service, *needs_drand0_started ]
    container_name: drand2
    image: drand:latest
    entrypoint: ./start-drand2.sh
    healthcheck:
      <<: *healthcheck_settings
      test: drand util ping http://drand2:8080

  lotus0:
    <<: [ *filecoin_service, *needs_all_drand_healthy ]
    container_name: lotus0
    image: lotus:latest
    entrypoint: [ "./scripts/start-lotus.sh", "0" ]
    healthcheck:
      <<: *healthcheck_settings
      test: curl --fail http://lotus0:1234/health/livez

  lotus1:
    <<: [ *filecoin_service, *needs_lotus0_healthy ]
    image: lotus:latest
    container_name: lotus1
    entrypoint: [ "./scripts/start-lotus.sh", "1" ]
    healthcheck:
      <<: *healthcheck_settings
      test: curl --fail http://lotus1:1234/health/livez

  forest0:
    <<: [ *filecoin_service, *needs_lotus0_healthy ]
    image: forest:latest
    container_name: forest0
    entrypoint: [ "./scripts/start-forest.sh", "0" ]

  workload:
    <<: [ *filecoin_service ]
    image: workload:latest
    container_name: workload
    environment:
      - STRESS_NODES=lotus0,lotus1,forest0
      - STRESS_RPC_PORT=1234
      - STRESS_FOREST_RPC_PORT=3456
      - STRESS_KEYSTORE_PATH=/shared/configs/stress_keystore.json
      - STRESS_WAIT_HEIGHT=10
      # --- Action deck weights (0 = disabled, N = relative frequency in random draw) ---
      # FIL transfers between wallets via the market actor
      - STRESS_WEIGHT_TRANSFER=1
      # Rapid-fire transactions from many wallets to spike mempool pressure
      - STRESS_WEIGHT_GAS_WAR=0
      # Concurrent conflicting messages from the same sender (double-spend attempts)
      - STRESS_WEIGHT_ADVERSARIAL=0
      # StateCompute re-execution and state root verification across nodes
      - STRESS_WEIGHT_HEAVY_COMPUTE=0
      # Cross-node tipset consensus, finality, and peer-connectivity checks
      - STRESS_WEIGHT_CHAIN_MONITOR=0
      # EVM contract deployment via EAM.CreateExternal
      - STRESS_WEIGHT_DEPLOY=0
      # Invoke already-deployed EVM contracts (recursive, delegatecall, simplecoin, etc.)
      - STRESS_WEIGHT_CONTRACT_CALL=0
      # Deploy a contract then immediately self-destruct it, stressing actor cleanup
      - STRESS_WEIGHT_SELFDESTRUCT=0
      # Two wallets call the same contract concurrently to race on shared state
      - STRESS_WEIGHT_CONTRACT_RACE=0
      # Tight keccak256 loop inside EVM to exhaust gas and stress the fee market
      - STRESS_WEIGHT_GAS_GUZZLER=0
      # Emit a large number of EVM events to stress receipt and log processing
      - STRESS_WEIGHT_LOG_BLASTER=0
      # Allocate maximum EVM memory to trigger quadratic memory expansion costs
      - STRESS_WEIGHT_MEMORY_BOMB=0
      # Write many unique storage slots to stress the state trie under load
      - STRESS_WEIGHT_STORAGE_SPAM=0
      # Disconnect/reconnect nodes to force chain reorgs and test convergence
      - STRESS_WEIGHT_REORG=0
      # FOC: read USDFC balances + SP registration via eth_call, assert payment invariants
      - STRESS_WEIGHT_FOC_MONITOR=3
      # FOC: ERC-20 USDFC transfer between client and deployer wallets
      - STRESS_WEIGHT_FOC_TRANSFER=1
      # FOC: approve FilecoinPay as spender + deposit USDFC into payment account
      - STRESS_WEIGHT_FOC_DEPOSIT=1
      # FOC: grant FWSS operator rights on the client's FilecoinPay account
      - STRESS_WEIGHT_FOC_APPROVE_OP=1
      # FOC: discover active payment rails and settle the first one found
      - STRESS_WEIGHT_FOC_SETTLE=1
      # FOC: withdraw available USDFC funds from FilecoinPay back to wallet
      - STRESS_WEIGHT_FOC_WITHDRAW=1
      # FOC adversarial: fire two concurrent settleRail calls for the same rail
      - STRESS_WEIGHT_FOC_DBL_SETTLE=1
      # FOC adversarial: run deposit and settle concurrently, check balance consistency
      - STRESS_WEIGHT_FOC_CONCURRENT=1
      # FOC adversarial: attempt zero-amount deposit, verify no state corruption
      - STRESS_WEIGHT_FOC_BOUNDARY=1
      - STRESS_DEBUG=1
    volumes:
      - ./shared/configs:/shared/configs
      - ./shared:/shared
      - ./data/lotus0:/root/devgen/lotus0
      - ./data/lotus1:/root/devgen/lotus1
      - ./data/forest0:/root/devgen/forest0
      - ./data/curio:/root/devgen/curio

  lotus-miner0:
    <<: [ *filecoin_service, *needs_lotus0_healthy ]
    image: lotus:latest
    container_name: lotus-miner0
    entrypoint: [ "./scripts/start-lotus-miner.sh", "0" ]

  lotus-miner1:
    <<: [ *filecoin_service, *needs_lotus1_healthy ]
    image: lotus:latest
    container_name: lotus-miner1
    entrypoint: [ "./scripts/start-lotus-miner.sh", "1" ]

  # ===========================================================================
  # foc profile: Filecoin On-Chain Cloud services (filwizard + yugabyte + curio)
  # Start with: docker compose --profile foc up -d
  # ===========================================================================

  # FilWizard: contract deployment + environment wiring
  filwizard:
    <<: [ *filecoin_service ]
    image: filwizard:latest
    container_name: filwizard
    entrypoint: [ "/filwizard-entrypoint.sh" ]
    volumes:
      - ./shared/configs:/shared/configs
      - ./data/lotus0:/shared/lotus0
      - ./data/curio:/shared/curio
      - ./shared:/shared
      - ./filwizard/entrypoint.sh:/filwizard-entrypoint.sh
    depends_on:
      lotus0:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "test", "-f", "/tmp/healthy" ]
      interval: 5s
      timeout: 2s
      retries: 120
    profiles: [ foc ]

  # Yugabyte Database Service
  yugabyte:
    <<: [ *filecoin_service ]
    image: yugabytedb/yugabyte:latest
    container_name: yugabyte
    init: true
    command: >
      bash -lc '
        bin/yugabyted start --base_dir=/home/yugabyte/yb_data --background=true --ui=false
        tail -F \
          /home/yugabyte/yb_data/data/yb-data/tserver/logs/yb-tserver.INFO
      '
    ports:
      - "5433:5433"
      - "9042:9042"
      - "15433:15433"
    environment:
      - TINI_SUBREAPER=true
    volumes:
      - ./data/yugabyte:/home/yugabyte/yb_data
    profiles: [ foc ]

  # Curio service
  curio:
    <<: [ *filecoin_service ]
    image: curio:${CURIO_TAG:-latest}
    container_name: curio
    ports:
      - "4433:443"
      - "8080:80"
      - "12300:12300"
      - "4701:4701"
      - "32100:32100"
    depends_on:
      lotus0:
        condition: service_healthy
      yugabyte:
        condition: service_started
      filwizard:
        condition: service_started
    profiles: [ foc ]
