package main

import (
	"bytes"
	"encoding/binary"
	"encoding/hex"
	"log"

	"github.com/antithesishq/antithesis-sdk-go/assert"
	"github.com/filecoin-project/go-address"
	"github.com/filecoin-project/go-state-types/abi"
	builtintypes "github.com/filecoin-project/go-state-types/builtin"
	"github.com/filecoin-project/lotus/api"
	"github.com/filecoin-project/lotus/chain/actors"
	"github.com/filecoin-project/lotus/chain/types"
	"github.com/ipfs/go-cid"
	cbg "github.com/whyrusleeping/cbor-gen"
	"golang.org/x/crypto/sha3"
)

// ===========================================================================
// Embedded EVM Contract Bytecodes (from Lotus test suite)
// ===========================================================================

var contractHex = map[string]string{
	// Recursive: recursiveCall(uint256) — deep internal recursion
	"recursive": "608060405234801561001057600080fd5b506102d9806100206000396000f3fe608060405234801561001057600080fd5b50600436106100575760003560e01c8063032cec451461005c57806372536f3c1461007a57806399fdb86e14610098578063d2aac3ea146100b6578063ec49254c146100d4575b600080fd5b610064610104565b60405161007191906101c7565b60405180910390f35b610082610115565b60405161008f91906101c7565b60405180910390f35b6100a0610126565b6040516100ad91906101c7565b60405180910390f35b6100be610137565b6040516100cb91906101c7565b60405180910390f35b6100ee60048036038101906100e99190610213565b610148565b6040516100fb91906101c7565b60405180910390f35b60006101106001610148565b905090565b6000610121600a610148565b905090565b60006101326002610148565b905090565b60006101436000610148565b905090565b6000808211156101a5577f3110e0ccd510fcbb471c933ad12161c459e8735b5bde2eea61a659c2e2f0a3cc8260405161018191906101c7565b60405180910390a161019e600183610199919061026f565b610148565b90506101a9565b8190505b919050565b6000819050919050565b6101c1816101ae565b82525050565b60006020820190506101dc60008301846101b8565b92915050565b600080fd5b6101f0816101ae565b81146101fb57600080fd5b50565b60008135905061020d816101e7565b92915050565b600060208284031215610229576102286101e2565b5b6000610237848285016101fe565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061027a826101ae565b9150610285836101ae565b925082820390508181111561029d5761029c610240565b5b9291505056fea26469706673582212206178e15eb87e2f766b94ec09a6a860878c93d72a31de225e1684da1755f917c764736f6c63430008110033",

	// SelfDestruct: destroy() — kills the actor
	"selfdestruct": "6080604052348015600f57600080fd5b5060848061001e6000396000f3fe6080604052348015600f57600080fd5b506004361060285760003560e01c806383197ef014602d575b600080fd5b60336035565b005b3373ffffffffffffffffffffffffffffffffffffffff16fffea2646970667358221220d4aa109d42268586e7ce4f0fafb0ebbd04c412c6c7e8c387b009a08ecdff864264736f6c63430008110033",

	// RecursiveDelegatecall: recursiveCall(uint256) — delegatecall recursion
	"delegatecall": "608060405234801561001057600080fd5b50610459806100206000396000f3fe608060405234801561001057600080fd5b50600436106100365760003560e01c80633af3f24f1461003b578063ec49254c14610059575b600080fd5b610043610089565b6040516100509190610221565b60405180910390f35b610073600480360381019061006e919061026d565b61008f565b6040516100809190610221565b60405180910390f35b60005481565b60007faab69767807d0ab32f0099452739da31b76ecd3e8694bb49898829c8bf9d063582306040516100c29291906102db565b60405180910390a160016000808282546100dc9190610333565b9250508190555060018211156101ff576001826100f99190610367565b91506000803073ffffffffffffffffffffffffffffffffffffffff16846040516024016101269190610221565b6040516020818303038152906040527fec49254c000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff83818316178352505050506040516101b0919061040c565b600060405180830381855af49150503d80600081146101eb576040519150601f19603f3d011682016040523d82523d6000602084013e6101f0565b606091505b50915091508392505050610203565b8190505b919050565b6000819050919050565b61021b81610208565b82525050565b60006020820190506102366000830184610212565b92915050565b600080fd5b61024a81610208565b811461025557600080fd5b50565b60008135905061026781610241565b92915050565b6000602082840312156102835761028261023c565b5b600061029184828501610258565b91505092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006102c58261029a565b9050919050565b6102d5816102ba565b82525050565b60006040820190506102f06000830185610212565b6102fd60208301846102cc565b9392505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061033e82610208565b915061034983610208565b925082820190508082111561036157610360610304565b5b92915050565b600061037282610208565b915061037d83610208565b925082820390508181111561039557610394610304565b5b92915050565b600081519050919050565b600081905092915050565b60005b838110156103cf5780820151818401526020810190506103b4565b60008484015250505050565b60006103e68261039b565b6103f081856103a6565b93506104008185602086016103b1565b80840191505092915050565b600061041882846103db565b91508190509291505056fea2646970667358221220e70fbbfaccd3fbb084623d6d06895fba1abc5fefc181215b56ab1e43db79c7fb64736f6c63430008110033",

	// SimpleCoin: sendCoin(address,uint256), getBalance(address) — stateful token
	"simplecoin": "608060405234801561001057600080fd5b506127106000803273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555061051c806100656000396000f3fe608060405234801561001057600080fd5b50600436106100415760003560e01c80637bd703e81461004657806390b98a1114610076578063f8b2cb4f146100a6575b600080fd5b610060600480360381019061005b919061030a565b6100d6565b60405161006d9190610350565b60405180910390f35b610090600480360381019061008b9190610397565b6100f4565b60405161009d91906103f2565b60405180910390f35b6100c060048036038101906100bb919061030a565b61025f565b6040516100cd9190610350565b60405180910390f35b600060026100e38361025f565b6100ed919061043c565b9050919050565b6000816000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205410156101455760009050610259565b816000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254610193919061047e565b92505081905550816000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546101e891906104b2565b925050819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8460405161024c9190610350565b60405180910390a3600190505b92915050565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006102d7826102ac565b9050919050565b6102e7816102cc565b81146102f257600080fd5b50565b600081359050610304816102de565b92915050565b6000602082840312156103205761031f6102a7565b5b600061032e848285016102f5565b91505092915050565b6000819050919050565b61034a81610337565b82525050565b60006020820190506103656000830184610341565b92915050565b61037481610337565b811461037f57600080fd5b50565b6000813590506103918161036b565b92915050565b600080604083850312156103ae576103ad6102a7565b5b60006103bc858286016102f5565b92505060206103cd85828601610382565b9150509250929050565b60008115159050919050565b6103ec816103d7565b82525050565b600060208201905061040760008301846103e3565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061044782610337565b915061045283610337565b925082820261046081610337565b915082820484148315176104775761047661040d565b5b5092915050565b600061048982610337565b915061049483610337565b92508282039050818111156104ac576104ab61040d565b5b92915050565b60006104bd82610337565b91506104c883610337565b92508282019050808211156104e0576104df61040d565b5b9291505056fea2646970667358221220050cdcfbe2911d041d2e6c355dbb6a0ca8ca70b500865bf33d9a2e5f4ac5a4e164736f6c63430008110033",

	// ExternalRecursiveCallSimple: exec1(uint256) — external this.call() recursion
	"extrecursive": "608060405234801561001057600080fd5b506101ee806100206000396000f3fe60806040526004361061001e5760003560e01c8063c38e07dd14610023575b600080fd5b61003d600480360381019061003891906100fe565b61003f565b005b60008111156100c0573073ffffffffffffffffffffffffffffffffffffffff1663c38e07dd600183610071919061015a565b6040518263ffffffff1660e01b815260040161008d919061019d565b600060405180830381600087803b1580156100a757600080fd5b505af11580156100bb573d6000803e3d6000fd5b505050505b50565b600080fd5b6000819050919050565b6100db816100c8565b81146100e657600080fd5b50565b6000813590506100f8816100d2565b92915050565b600060208284031215610114576101136100c3565b5b6000610122848285016100e9565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610165826100c8565b9150610170836100c8565b92508282039050818111156101885761018761012b565b5b92915050565b610197816100c8565b82525050565b60006020820190506101b2600083018461018e565b9291505056fea264697066735822122033d012e17f5d7a62bb724021b5c4e0d109aeb28d1cd5b5c0a0b1b801c0b5032164736f6c63430008110033",

	// --- Resource stress contracts (compiled from Solidity 0.8.30) ---

	// GasGuzzler: burnGas(uint256) — tight keccak256 loop to max out block gas
	"gasguzzler": "6080604052348015600e575f5ffd5b506101028061001c5f395ff3fe6080604052348015600e575f5ffd5b50600436106026575f3560e01c80634ad5d16f14602a575b5f5ffd5b6039603536600460b6565b604b565b60405190815260200160405180910390f35b5f5f43604051602001605f91815260200190565b60408051601f19818403018152919052805160209091012090505f5b8381101560af5760408051602081018490520160408051601f1981840301815291905280516020909101209150600101607b565b5092915050565b5f6020828403121560c5575f5ffd5b503591905056fea2646970667358221220d30bb16e3370f89419bbd88e72efb6817d05edaffe77b39764d5647b25729cab64736f6c634300081e0033",

	// LogBlaster: blastLogs(uint256) — emits N events to stress receipt/bloom storage
	"logblaster": "6080604052348015600e575f5ffd5b5060fc8061001b5f395ff3fe6080604052348015600e575f5ffd5b50600436106026575f3560e01c80632d7bf0de14602a575b5f5ffd5b6039603536600460b0565b603b565b005b5f5b8181101560ac57807f47df3ef8f8bb567903a8b76f58756a57fdacce2c4f7afa10c4cb848842bd770582436040516020016081929190918252602082015260400190565b60408051601f1981840301815290829052805160209182012082520160405180910390a2600101603d565b5050565b5f6020828403121560bf575f5ffd5b503591905056fea2646970667358221220876bc8339d387340e0513ff11927e6e7c4f24b7fd78b8bc7ac65520714e0d69464736f6c634300081e0033",

	// MemoryBomb: expandMemory(uint256) — allocates N words of EVM memory (quadratic cost)
	"memorybomb": "6080604052348015600e575f5ffd5b5060c180601a5f395ff3fe6080604052348015600e575f5ffd5b50600436106026575f3560e01c8063f96ef55614602a575b5f5ffd5b603960353660046075565b604b565b60405190815260200160405180910390f35b5f5f604051602084028101815b818110156069578080526020016058565b50604052519392505050565b5f602082840312156084575f5ffd5b503591905056fea264697066735822122046473c6fbb8bdf95b2251a701cb09276cd769bf41dca324caf86e041eea7978064736f6c634300081e0033",

	// StorageSpammer: spamSlots(uint256,uint256) — writes N unique storage slots per call
	"storagespam": "6080604052348015600e575f5ffd5b506101758061001c5f395ff3fe608060405234801561000f575f5ffd5b5060043610610034575f3560e01c8063387dd9e9146100385780637af1a18314610069575b5f5ffd5b6100576100463660046100e3565b5f6020819052908152604090205481565b60405190815260200160405180910390f35b61007c6100773660046100fa565b61007e565b005b5f5b828110156100de5761009381600161011a565b5f5f83856040516020016100b1929190918252602082015260400190565b60408051601f198184030181529181528151602092830120835290820192909252015f2055600101610080565b505050565b5f602082840312156100f3575f5ffd5b5035919050565b5f5f6040838503121561010b575f5ffd5b50508035926020909101359150565b8082018082111561013957634e487b7160e01b5f52601160045260245ffd5b9291505056fea26469706673582212206ea170243d1d69348ab3f8a1ba8afcfb5f4ebdf67dce795f393fa4432810ca7764736f6c634300081e0033",
}

// ===========================================================================
// Initialization
// ===========================================================================

func initContractBytecodes() {
	contractBytecodes = make(map[string][]byte, len(contractHex))
	for name, hexStr := range contractHex {
		b, err := hex.DecodeString(hexStr)
		if err != nil {
			log.Printf("[contracts] WARN: cannot decode hex for %s: %v", name, err)
			continue
		}
		contractBytecodes[name] = b
	}
	contractTypes = make([]string, 0, len(contractBytecodes))
	for name := range contractBytecodes {
		contractTypes = append(contractTypes, name)
	}
	log.Printf("[contracts] loaded %d contract bytecodes", len(contractBytecodes))
}

// ===========================================================================
// EVM Helpers
// ===========================================================================

// calcSelector returns the first 4 bytes of keccak256(funcSig).
// e.g. calcSelector("recursiveCall(uint256)") → function selector bytes.
func calcSelector(funcSig string) []byte {
	hasher := sha3.NewLegacyKeccak256()
	hasher.Write([]byte(funcSig))
	return hasher.Sum(nil)[:4]
}

// encodeUint256 ABI-encodes a uint64 as a 32-byte big-endian uint256.
func encodeUint256(n uint64) []byte {
	buf := make([]byte, 32)
	binary.BigEndian.PutUint64(buf[24:], n)
	return buf
}

// encodeAddress ABI-encodes an Ethereum-style address as a 32-byte padded value.
// Takes raw 20-byte address, left-pads to 32.
func encodeAddress(addr []byte) []byte {
	buf := make([]byte, 32)
	if len(addr) >= 20 {
		copy(buf[12:], addr[:20])
	}
	return buf
}

// cborWrapCalldata wraps EVM calldata (selector + args) as CBOR byte array
// for the MethodsEVM.InvokeContract params field.
func cborWrapCalldata(selector []byte, args ...[]byte) ([]byte, error) {
	data := make([]byte, len(selector))
	copy(data, selector)
	for _, arg := range args {
		data = append(data, arg...)
	}
	var buf bytes.Buffer
	if err := cbg.WriteByteArray(&buf, data); err != nil {
		return nil, err
	}
	return buf.Bytes(), nil
}

// ===========================================================================
// Contract Message Helpers
// ===========================================================================

// pushContractMsg estimates gas, signs locally, and pushes a contract message.
// Returns the message CID and success status.
func pushContractMsg(node api.FullNode, msg *types.Message, ki *types.KeyInfo, tag string) (cid.Cid, bool) {
	msg.Nonce = nonces[msg.From]

	// Let the node estimate gas
	gasMsg, err := node.GasEstimateMessageGas(ctx, msg, nil, types.EmptyTSK)
	if err != nil {
		log.Printf("[%s] GasEstimateMessageGas failed: %v, using fallback", tag, err)
		msg.GasLimit = 500_000_000
		msg.GasFeeCap = abi.NewTokenAmount(150_000)
		msg.GasPremium = abi.NewTokenAmount(1_000)
	} else {
		msg.GasLimit = gasMsg.GasLimit
		msg.GasFeeCap = gasMsg.GasFeeCap
		msg.GasPremium = gasMsg.GasPremium
	}

	smsg := signMsg(msg, ki)
	if smsg == nil {
		return cid.Undef, false
	}

	msgCid, err := node.MpoolPush(ctx, smsg)
	if err != nil {
		log.Printf("[%s] MpoolPush failed: %v", tag, err)
		return cid.Undef, false
	}

	nonces[msg.From]++
	return msgCid, true
}

// deployContract deploys an EVM contract via EAM.CreateExternal.
func deployContract(node api.FullNode, from address.Address, ki *types.KeyInfo,
	bytecode []byte, tag string) (cid.Cid, bool) {

	initcode := abi.CborBytes(bytecode)
	params, err := actors.SerializeParams(&initcode)
	if err != nil {
		log.Printf("[%s] SerializeParams failed: %v", tag, err)
		return cid.Undef, false
	}

	msg := &types.Message{
		From:   from,
		To:     builtintypes.EthereumAddressManagerActorAddr,
		Value:  abi.NewTokenAmount(0),
		Method: builtintypes.MethodsEAM.CreateExternal,
		Params: params,
	}

	return pushContractMsg(node, msg, ki, tag)
}

// invokeContract invokes a deployed EVM contract with the given calldata.
func invokeContract(node api.FullNode, from address.Address, ki *types.KeyInfo,
	contractAddr address.Address, calldata []byte, tag string) (cid.Cid, bool) {

	msg := &types.Message{
		From:   from,
		To:     contractAddr,
		Value:  abi.NewTokenAmount(0),
		Method: builtintypes.MethodsEVM.InvokeContract,
		Params: calldata,
	}

	return pushContractMsg(node, msg, ki, tag)
}

// doDeployStressContract deploys a contract type on-demand and tracks it
// via pendingDeploys for later resolution by resolvePendingDeploys.
func doDeployStressContract(ctype string) {
	bytecode := contractBytecodes[ctype]
	if bytecode == nil {
		return
	}
	fromAddr, fromKI := pickWallet()
	nodeName, node := pickNode()

	msgCid, ok := deployContract(node, fromAddr, fromKI, bytecode, "deploy-"+ctype)
	if !ok {
		log.Printf("[deploy] failed to deploy %s via %s", ctype, nodeName)
		return
	}

	head, err := node.ChainHead(ctx)
	epoch := abi.ChainEpoch(0)
	if err == nil {
		epoch = head.Height()
	}

	pendingMu.Lock()
	if len(pendingDeploys) < maxPendingDeploys {
		pendingDeploys = append(pendingDeploys, pendingDeploy{
			msgCid:   msgCid,
			ctype:    ctype,
			deployer: fromAddr,
			deployKI: fromKI,
			epoch:    epoch,
		})
	}
	pendingMu.Unlock()

	log.Printf("  [deploy] submitted %s deploy via %s (cid=%s)", ctype, nodeName, cidStr(msgCid))

	assert.Sometimes(true, "contract_deploy_submitted", map[string]any{
		"type": ctype,
		"node": nodeName,
	})
}
